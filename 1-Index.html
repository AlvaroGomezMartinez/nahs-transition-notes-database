<!doctype html>
<html lang="en">

<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NAHS Transition Notes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <script>
    // Function to display the HTML table with initial data (Roster)
    function displayTable(data) {
      console.log(data);
      var htmlTable = '<table class="table table-dark table-hover">';
      htmlTable += '<thead><tr>';
      htmlTable += '<th scope="col">Index</th>';
      htmlTable += '<th scope="col">ID</th>';
      htmlTable += '<th scope="col">Name</th>';
      htmlTable += '<th scope="col">Grade</th>';
      htmlTable += '<th scope="col">Course</th>';
      htmlTable += '<th scope="col">Transfer Grade</th>';
      htmlTable += '<th scope="col">Current Grade</th>';
      htmlTable += '<th scope="col">How would you assess this student\'s academic growth?</th>';
      htmlTable += '<th scope="col">Academic and Behavioral Progress</th>';
      htmlTable += '<th scope="col">Actions</th>';
      htmlTable += '</tr></thead>';

      htmlTable += '<tbody class="table-group-divider">';
      // Table (Roster) rows from results
      data.forEach(function (row) {
        htmlTable += '<tr>';
        htmlTable += '<th scope="row">' + row[0] + '</th>'; // Index column
        htmlTable += '<td>' + row[2] + '</td>'; // ID column
        htmlTable += '<td>' + row[1] + '</td>'; // Name column
        htmlTable += '<td>' + row[3] + '</td>'; // Grade column
        htmlTable += '<td>' + row[4] + '</td>'; // Course Title
        htmlTable += '<td>' + row[5] + '</td>'; // Transfer Grade
        htmlTable += '<td>' + row[6] + '</td>'; // Current Grade
        htmlTable += '<td>' + row[7] + '</td>'; // Academic Growth
        htmlTable += '<td>' + row[8] + '</td>'; // Progress

        htmlTable += '<td><button class="btn btn-primary edit-button" onclick="editRecord(' + JSON.stringify({
          index: row[0],
          id: row[1],
          name: row[2],
          grade: row[3],
          course: row[4]
        }).replace(/"/g, '&quot;') + ')">Edit</button></td>';

        htmlTable += '</tr>';
      });

      htmlTable += '</tbody>';

      htmlTable += '</table>';

      // Display table in the current HTML document
      document.getElementById('tableContainer').innerHTML = htmlTable;

    }

    // Function to handle the update button click event
    function updateOpenedRecord() {
      const index = document.getElementById("index").value;
      // Collect form data into an object
      const formData = {
        index: index,
        id: document.getElementById("id").value,
        name: document.getElementById("name").value,
        grade: document.getElementById("grade").value,
        course: document.getElementById("course").value,
        trnfrGrd: document.getElementById("trnfrGrd").value,
        currGrd: document.getElementById("currGrd").value,
        growth: document.getElementById("growth").value,
        progress: document.getElementById("progress").value
      };

      // Call the server-side function to update the record
      google.script.run.withSuccessHandler(function (result) {
        // Reset form and show success message after record is updated
        document.getElementById("form").reset();
        alert('Record updated successfully!');
        // Optionally, refresh data or UI here
        displayTable(result);
      }).withFailureHandler(function (error) {
        // Handle errors, possibly show an error message
        console.error("Failed to update record:", error);
        alert('Failed to update the record.');
      }).updateOpenedRecord(formData);
    }

    // Function to add data from the Roster spreadsheet into the Teacher Data Form
    function editRecord(rowData) {
      // Safely attempt to set the value of each element, if it exists
      const elements = {
        index: rowData.index,
        id: rowData.id,
        name: rowData.name,
        grade: rowData.grade,
        course: rowData.course
      };

      Object.keys(elements).forEach(key => {
        const element = document.getElementById(key);
        if (element) { // Check if the element exists
          element.value = elements[key];
        } else {
          console.error(`Element with ID '${key}' not found.`);
        }
      });
    }

    // Function to clear the form fields
    function clearForm() {
      document.getElementById("form").reset();
    }

    // Function to add a record from the dropdown
    function addRecord() {
      var dropdown = document.getElementById("dropdown");
      var selectedValue = dropdown.options[dropdown.selectedIndex].value;

      if (selectedValue !== "") {
        // Find the selected row in the globalData array
        var selectedRow = globalData.find(function (row) {
          return row[1] === selectedValue;
        });

        if (selectedRow) {
          editRecord({
            index: selectedRow[0],
            id: selectedRow[1],
            name: selectedRow[2],
            grade: selectedRow[3],
            course: selectedRow[4]
          });
        }
      }
    }

    // Function to fetch initial data and display the table upon window load
    window.onload = function () {
      google.script.run.withSuccessHandler(function (data) {
        globalData = data; // Store fetched data in global variable
        displayTable(data); // Call displayTable with the fetched data
        populateDropdown(data); // Populate dropdown with data
      }).fetchInitialData();
    };

    // Function to populate the dropdown menu with data
    function populateDropdown(data) {
      var dropdown = document.getElementById("dropdown");
      data.forEach(function (row) {
        var option = document.createElement("option");
        option.value = row[1]; // Use ID as value
        option.text = row[2]; // Use Name as display text
        dropdown.add(option);
      });
    }
  </script>

</head>

<body>
  <div class="container text-center">
    <div class="row">
      <div class="col-md-5">
        <img src="https://i.imgur.com/xINeSCJ.png" class="rounded float-start" alt="NAHS Logo">
      </div>
      <div class="col-md-7">
        <h1 class="display-1">AEP Personalized Transition Plan</h1>
      </div>
      <hr>
    </div>
    <div class="row">
      <p class="text-start"><b>Purpose: </b>This web app facilitates the creation of a personalized transition plan for
        students assigned to NAHS. The personalized transition plan is part of a coordination system between transition
        teams at each high school campus and NAHS as required by <a
          href="https://texas.public.law/statutes/tex._educ._code_section_37.023" target="_blank">Texas Education Code
          ยง37.023</a>. Your prompt attention to providing the needed information is important to meeting the required
        timelines.</p>
      <p class="text-start"><b>Instructions: </b>Look at the roster on the table below. If you have a student who is
        missing information in the last four columns, click on the blue <i>Edit</i> button. The common information will
        fill in on the <i>Teacher Data Form</i>. Fill in the fields in the <i>Teacher Data Form</i> with the missing
        data then click on the green <i>Update Record</i> button below it.</p>
      </p>
      <hr>
    </div>
    <div class="row">
      <div class="col-3 text-start">
        <h2>Teacher Data Form</h2>
        <!-- Form for adding/updating records -->
        <form id="form">
          <label for="index" class="form-label fw-bold">Index:</label>
          <input class="form-control" id="index" type="text" name="index" autocomplete="off" disabled>

          <label for="id" class="form-label fw-bold">ID:</label>
          <input class="form-control" id="id" type="text" name="id" autocomplete="off" disabled>

          <label for="name" class="form-label fw-bold">Name:</label>
          <input class="form-control" id="name" type="text" name="name" autocomplete="off" disabled>

          <label for="grade" class="form-label fw-bold">Grade:</label>
          <input class="form-control" id="grade" type="text" name="grade" autocomplete="off" disabled>

          <label for="course" class="form-label fw-bold">Course:</label>
          <input class="form-control" id="course" type="text" name="course" autocomplete="off" disabled>

          <label for="trnfrGrd" class="form-label fw-bold">Transfer Grade:</label>
          <input class="form-control" id="trnfrGrd" type="text" name="trnfrGrd" autocomplete="off">

          <label for="currGrd" class="form-label fw-bold">Current Grade:</label>
          <input class="form-control" id="currGrd" type="text" name="currGrd" autocomplete="off" required
            style="width: 55px;">

          <label for="growth" class="form-label fw-bold">How would you assess this student's academic growth?</label>
          <textarea class="form-control" id="growth" name="growth" rows="3"></textarea>

          <label for="progress" class="form-label fw-bold">Academic and Behavioral Progress:</label>
          <textarea class="form-control" id="progress" name="progress" rows="3"></textarea>

          <br>
          <button class="btn btn-success" type="button" onclick="updateOpenedRecord()">Update Record</button>
          <button class="btn btn-secondary" type="button" onclick="clearForm()">Clear</button>
        </form>

        <h2>Add Student</h2>
        <!-- Dropdown to select a student -->
        <select class="form-select" id="dropdown">
          <option selected disabled>Select a student</option>
        </select>
        <button class="btn btn-primary mt-2" type="button" onclick="addRecord()">Add Record</button>
      </div>
      <div class="col-9 text-start">
        <h2>Roster</h2>
        <!-- Container for displaying the HTML table -->
        <div id="tableContainer"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-oBqDVmMz4fnFO9gybBogGzA81W1y7D2KJtcpw6UJlA8swlPA9KbzeQoW8zZOi2I6"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
    integrity="sha384-qF9awpkY8hF/84BxP2vD9JbbhOprEys9X2c4l2pKyMVIjsu8s+cGyh9FZ79Pz91" crossorigin="anonymous"></script>
</body>

</html>